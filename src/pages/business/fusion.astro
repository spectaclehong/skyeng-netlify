---
import Layout from '~/layouts/PageLayout.astro';
import Hero3 from '~/components/widgets/Hero3.astro';
import SideNav from '~/components/widgets/SideNav.astro';
import Image from '~/components/common/Image.astro';
import { findImage } from '~/utils/images';

const metadata = {
  title: '핵융합사업 | 하늘엔지니어링',
  description: 'KSTAR, ITER, DTT 등 국제 핵융합 프로젝트 참여 경험과 극저온 시스템 설계·제작 전문성을 보유하고 있습니다.',
};


// Read image metadata to populate sizes
const enrichWithMeta = async <T extends { src: string }>(items: Array<T>) => {
  return await Promise.all(
    items.map(async (item) => {
      const meta = await findImage(item.src);
      const width = typeof meta !== 'string' && meta?.width ? Number(meta.width) : undefined;
      const height = typeof meta !== 'string' && meta?.height ? Number(meta.height) : undefined;
      return { ...(item as T), width, height } as T & {
        width?: number;
        height?: number;
      };
    })
  );
};

// Only use the six specified images (Design + 5 Manufacturing summaries)
const kstarOverview = [
  {
    src: '~/assets/images/business/fusion/kstar/1. Design.png',
    title: 'Design',
  },
  {
    src: '~/assets/images/business/fusion/kstar/2. Manufacturing : Liquid Helium Transfer Line(DB#2).png',
    title: 'Manufacturing : Liquid Helium Transfer Line(DB#2)',
  },
  {
    src: '~/assets/images/business/fusion/kstar/3. Manufacturing : Liquid Helium Distribution Box(DB#2).png',
    title: 'Manufacturing : Liquid Helium Distribution Box(DB#2)',
  },
  {
    src: '~/assets/images/business/fusion/kstar/4. Manufacturing : Internal Process Piping(DB#2).png',
    title: 'Manufacturing : Internal Process Piping(DB#2)',
  },
  {
    src: '~/assets/images/business/fusion/kstar/5. Manufacturing : Liquid Helium Distribution System Upgrade(DBU).png',
    title: 'Manufacturing : Liquid Helium Distribution System Upgrade(DBU)',
  },
  {
    src: '~/assets/images/business/fusion/kstar/6. Manufacturing : Super Conducting Current Lead System.png',
    title: 'Manufacturing : Super Conducting Current Lead System',
  },
];

const kstarOverviewMeta = await enrichWithMeta(kstarOverview);

// Two large hero images to display above 1. Design.png
const kstarDesignHeros = [
  { src: '~/assets/images/business/fusion/kstar/1. Design - hero1.png', title: 'Design – Hero 1' },
  { src: '~/assets/images/business/fusion/kstar/1. Design - hero2.png', title: 'Design – Hero 2' },
];
const kstarDesignHerosMeta = await enrichWithMeta(kstarDesignHeros);
---

<Layout metadata={metadata}>
  <Hero3 title="핵융합 사업" subtitle="KSTAR · ITER · DTT 프로젝트 수행" imageSrc="~/assets/images/business/fusion/hero.png" imageAlt="핵융합 사업" />
  <SideNav items={[
    { href: '/business/fusion', label: '핵융합 사업' },
    { href: '/business/accelerator', label: '가속기 사업' },
    { href: '/business/aerospace', label: '우주항공 사업' },
    { href: '/business/defense', label: '국방과학 사업' },
    { href: '/business/battery', label: '2차전지 관련 사업' },
    { href: '/business/semiconductor', label: '반도체 관련 사업' },
  ]} />

  <!-- 1) KSTAR Participation -->
  <section class="mx-auto max-w-6xl px-6 py-16 md:py-20">
    <h2 class="text-2xl font-bold mb-6">1. KSTAR (Korea Superconducting Tokamak Advanced Research)</h2>

    <!-- Design hero images row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      {kstarDesignHerosMeta.map((hero) => (
        <figure class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-white">
          <Image
            src={hero.src}
            alt={hero.title}
            layout="constrained"
            width={hero.width}
            height={hero.height}
            class="w-full h-auto object-cover"
          />
        </figure>
      ))}
    </div>

    <div class="space-y-10">
      {kstarOverviewMeta.map((item) => (
        <div>
          <h3 class="text-lg font-semibold mb-3">{item.title}</h3>
          <figure class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-800 bg-white dark:bg-white">
            <Image 
              src={item.src} 
              alt={item.title} 
              layout="constrained" 
              width={item.width} 
              height={item.height} 
              class="w-full h-auto object-cover" 
            />
          </figure>
        </div>
      ))}
    </div>
  </section>

  <!-- 2) ITER Participation -->
  <section class="mx-auto max-w-6xl px-6 pb-16 md:pb-20">
    <h2 class="text-2xl font-bold mb-6">2. ITER (International Thermonuclear Experimental Reactor) 참여 사업</h2>
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Design</h3>
      <p class="text-sm text-gray-700 dark:text-gray-300">Vacuum Vessel, E/L Ports, TF Coil Structure Components, Vacuum Vessel Gravity Support & NB Port In-Wall Shield Block.</p>
    </div>
    <div>
      <h3 class="text-lg font-semibold mb-3">Manufacturing</h3>
      <ul class="list-disc pl-5 text-sm space-y-1">
        <li>VVGS (Vacuum Vessel Gravity Support) 제작 및 시험</li>
        <li>NB IWS (In-Wall Shield Block)</li>
        <li>ITER TFCS Components</li>
        <li>ITER Helium Leak Test for TFCS & LPSE</li>
        <li>ITER Hydrogen Absorption/Desorption Bed (R&D)</li>
      </ul>
    </div>
  </section>

  <!-- 3) DTT Participation -->
  <section class="mx-auto max-w-6xl px-6 pb-24">
    <h2 class="text-2xl font-bold mb-4">3. DTT (Divertor Tokamak Test Facility) 참여 사업</h2>
    <div class="rounded-lg border border-amber-300 bg-amber-50 dark:border-amber-400/40 dark:bg-amber-900/20 p-4 text-sm">
      계약서 서명 후 자료 업데이트 예정
    </div>
  </section>
</Layout>
